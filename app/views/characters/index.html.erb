<p id="notice"><%= notice %></p>

<h1><%= t ".title" %></h1>

<!-- ここから検索フィールド -->
<div class="search-field-wrap">
  <%= form_with url: characters_path, method: :get, local: true do %>
    <div class="text-field">
      <%= text_field_tag :keyword,
                         params[:keyword],
                         placeholder: "キーワード入力",
                         onkeydown: "SearchFieldKeyDown()",
                         onclick: "KeywordClearDisplay()" %>
      <div id="search-field-clear" class="clear-button fas fa-times" onclick="KeywordClearButton()">
        <!-- ツールチップ -->
        <div class="search-clear-balloon">フォームクリア</div>
      </div>
    </div>
    <div class="radio-buttons">
      <%= collection_radio_buttons(:gun_category, :gun_category_id, GunCategory.all, :id, :name, params[:gun_category].blank? ? {checked: false} : {checked: params[:gun_category][:gun_category_id]}) %>
    </div>
    <%= select_tag(:gun_type, options_from_collection_for_select(GunType.order(:ruby), :id, :name, selected: params[:gun_type]), {include_blank: "銃の種類を選択"}) %>
    <%= select_tag(:country, options_from_collection_for_select(Country.order(:ruby), :id, :name, selected: params[:country]), {include_blank: "国名を選択"}) %>
    <%= submit_tag "Search" %>
    <%= link_to characters_path do %>
      <%= button_tag "Reset" %>
    <% end %>
  <% end %>
</div>
<!-- ここまで検索フィールド -->

<div>
  <%= paginate @characters %>
</div>

<table class="cell-width-setting"><!-- 列の幅設定 -->
  <thead>
    <tr>
      <!-- ここからソート用変数 -->
      <!-- gun_category_idはハッシュ形式で変数に格納する -->
      <% @gun_category = params[:gun_category].blank? ? nil : {gun_category_id: params[:gun_category][:gun_category_id] } %>
      <!-- sort_orderに渡す検索対象カラム -->
      <% @search_theme = {keyword: params[:keyword], gun_category: @gun_category, gun_type: params[:gun_type], country: params[:country]} %>
      <!-- ここまでソート用変数 -->
      <th class="sort-link">
        <%= sort_order "name_ja", "Name ja", @search_theme %>
        <!-- ツールチップ -->
        <div class="sort-link-width-setting">
          <div class="sort-link-balloon">日本語名ソート</div>
        </div>
      </th>
      <th class="sort-link">
        <%= sort_order "name_en", "Name en", @search_theme %>
        <!-- ツールチップ -->
        <div class="sort-link-width-setting">
          <div class="sort-link-balloon">英語名ソート</div>
        </div>
      </th>
      <th class="sort-link">
        <%= sort_order "name_gun", "Name gun", @search_theme %>
        <!-- ツールチップ -->
        <div class="sort-link-width-setting">
          <div class="sort-link-balloon">モチーフ名ソート</div>
        </div>
      </th>
      <th></th>
      <th>Gun category</th>
      <th>Gun type</th>
      <th>Country</th>
      <th class="cell-width-motif">Motif</th>
      <th colspan="3" class="cell-width-icon">Do</th>
    </tr>
  </thead>

  <tbody>
    <% @characters.each do |character| %>
      <tr>
        <td><%= character.name_ja %></td>
        <td><%= character.name_en %></td>
        <td><%= character.name_gun %></td>
        <td>
          <% if character.images.present? %>
            <%= image_tag character.images.first, class: "top-thumbnail" %>
          <% end %>
        </td>
        <td><%= character.gun_category_id %></td>
        <td><%= character.gun_type_id %></td>
        <td><%= character.country_id %></td>
        <td><%= character.motif %></td>
        <td class="tooltip-icon">
          <!-- take_paramsメソッドで検索条件保持 -->
          <%= link_to character_path(character, take_params) do %>
            <i class="fas fa-info-circle"></i>
          <% end %>
          <!-- ツールチップ -->
          <div class="tooltip-icon-balloon tooltip-design-show">もっと見る</div>
        </td>
        <td class="tooltip-icon">
          <%= link_to edit_character_path(character, take_params) do %>
            <i class="fas fa-edit"></i>
          <% end %>
          <!-- ツールチップ -->
          <div class="tooltip-icon-balloon tooltip-design-edit">編集</div>
        </td>
        <td class="tooltip-icon">
          <%= link_to character, method: :delete, data: { confirm: t(".message") } do %>
            <i class="fas fa-trash-alt"></i>
          <% end %>
          <!-- ツールチップ -->
          <div class="tooltip-icon-balloon tooltip-design-destroy">削除</div>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Character', new_character_path(take_params) %>

<script>
  // onclick 検索フィールドクリアボタン
  function KeywordClearButton(){
    this.keyword.value="";
    this.keyword.focus(); // クリアボタン押下でフォーカス
    target = document.getElementById("search-field-clear");
    target.style.visibility = "hidden"; // キーワードクリアでクリアボタンも非表示にする
  }

  // onkeydown 入力時のみクリアボタン表示
  function SearchFieldKeyDown(){
    if (this.keyword.value.length > 0){
      target = document.getElementById("search-field-clear");
      target.style.visibility = "visible";
    }
  }

  // Search後入力フィールドクリックでクリアボタン表示
  function KeywordClearDisplay(){
    if (this.keyword.value.length > 0){
      target = document.getElementById("search-field-clear");
      target.style.visibility = "visible";
    }
  }

  // オートコンプリート
  window.addEventListener('keydown', function(){
    data = <%== Character.pluck(:name_ja, :name_en, :name_gun).flatten.uniq %>;
    $("#keyword").autocomplete({
      // 前方一致で候補を表示
      source: function(request, response) {
        response(
          $.grep(data, function(value){
            return value.indexOf(request.term) === 0;
          })
        );
      }
    });
  });
</script>
